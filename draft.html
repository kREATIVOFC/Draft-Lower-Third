<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lower Third Schema</title>
  <style>
    body { margin:0; padding:0; background:transparent; overflow:hidden; height:100vh; font-family:Arial,sans-serif; }
    .wrapper { position:absolute; bottom:50px; left:0; width:100%; height:110px; display:flex; }
    .sec1 { width:390px; background:#ff7a52; display:flex; justify-content:center; align-items:center; }
    .sec1 img { max-height:80px; }
    .sec2 { flex:1; background:#803d29; display:flex; align-items:center; padding:0 20px; gap:20px; }
    .sec2 img { height:80px; width:80px; object-fit:cover; border-radius:5px; }
    .sec2 .person-text { display:flex; flex-direction:column; gap:6px; color:white; }
    .sec3 { width:calc(100% - 395px); background:#803d29; position:relative; overflow:hidden; }
    .ticker { position:absolute; top:0; animation:scroll 48s infinite; }
    .ticker-item { height:110px; display:flex; align-items:center; justify-content:center; font-size:18px; color:white; }
    @keyframes scroll {
      0% {transform:translateY(0%);} 12.5% {transform:translateY(0%);}
      16.66% {transform:translateY(-100%);} 29.16% {transform:translateY(-100%);}
      33.33% {transform:translateY(-200%);} 45.83% {transform:translateY(-200%);}
      50% {transform:translateY(-300%);} 62.5% {transform:translateY(-300%);}
      66.66% {transform:translateY(-400%);} 79.16% {transform:translateY(-400%);}
      83.33% {transform:translateY(-500%);} 95.83% {transform:translateY(-500%);}
      100% {transform:translateY(0);}
    }
  </style>
</head>
<body>
<div class="wrapper">
  <div class="sec1"><img id="logo1" src="" alt="Logo"></div>
  <div class="sec2">
    <img id="personImg" alt="Person">
    <div class="person-text">
      <div id="nameLine"></div>
      <div id="timerLine"></div>
      <div id="roundLine"></div>
    </div>
  </div>
  <div class="sec3"><div class="ticker" id="ticker"></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  const SHEET_ID = '1niFCUtwdUAuy5yb65oXfPv50w-UPoqMYj_QRhsV-jeA';
  const CSV = sheet => `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheet)}`;
  let draft = [], imgTab = [];

  function fetchCSV(sheet, cb) {
    Papa.parse(CSV(sheet), { download: true, header: true, complete: r => cb(r.data) });
  }

  function startTimer(secs) {
    const line = document.getElementById('timerLine');
    let rem = secs;
    clearInterval(window._pickTimer);
    window._pickTimer = setInterval(() => {
      if (rem <= 0) {
        line.textContent = 'Låst';
        clearInterval(window._pickTimer);
      } else {
        const m = Math.floor(rem / 60), s = String(rem % 60).padStart(2, '0');
        line.textContent = `Pick – ${m}:${s}`;
        rem--;
      }
    }, 1000);
  }

  function render() {
    const active = draft.find(r => r['Active?'] === '✔️') || {};
    const name = active['Name'] || '';
    const pickNumber = active['Pick number'] || '';
    const round = active['Round'] || '';
    const isLocked = active['Pick Locked?'] === '✔️';

    const imgRec = imgTab.find(r => r.Namn === name) || {};

    document.getElementById('logo1').src = imgRec.Logotyplänk || '';
    document.getElementById('personImg').src = imgRec.Bildlänk || '';
    document.getElementById('nameLine').textContent = name;
    document.getElementById('roundLine').textContent = round;

    if (pickNumber) {
      if (isLocked) {
        document.getElementById('timerLine').textContent = 'Låst';
      } else {
        startTimer(300);
      }
    }

    const tick = document.getElementById('ticker');
    tick.innerHTML = '';
    const items = draft
      .filter(r => r['Active?'] === '✔️')
      .map(r => `${r['Pick number']} - ${r.Name}`);

    items.concat(items).forEach(txt => {
      const d = document.createElement('div');
      d.className = 'ticker-item';
      d.textContent = txt;
      tick.appendChild(d);
    });
  }

  function init() {
    fetchCSV('Draft', d => {
      draft = d;
      fetchCSV('BildTabell', b => {
        imgTab = b;
        render();
      });
    });
  }

  init();
  setInterval(init, 60000); // Uppdatera varje minut
</script>
</body>
</html>
